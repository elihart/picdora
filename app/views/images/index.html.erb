<div id="home">
  <h1 id="title">Picdora</h1>

  <div id="instructions">
    <p>Choose categories and settings then press go</p>

    <p>Press any key to change pictures</p>

    <p>Toggle fullscreen with 'f'</p>
  </div>

  <div id="options">


    <div id="settings_container">
      <h3 class="ui-widget-header ui-corner-all">Settings</h3>

      <div id="settings_content">

        <div id="nsfw_option" class="settings">
          <input type="checkbox" id="nsfw_check"/><label for="nsfw_check">NSFW</label>
        </div>

        <div id="gif_option" class="settings">
          <input type="checkbox" id="gif_check"/><label for="gif_check">GIF's</label>
        </div>

        <div id="slideshow_option" class="settings">
          <input type="checkbox" id="slideshow_check"/><label for="slideshow_check">Slideshow</label>

          <div id="time_slider">
            <p>
              <label for="time">Time:</label>
              <input type="text" id="time" style="border: 0; color: #f6931f; font-weight: bold;"/>
            </p>

            <div id="slider-range-min"></div>
          </div>
        </div>

      </div>
    </div>

    <div id="categories_container">
      <h3 class="ui-widget-header ui-corner-all">Categories</h3>

      <div id="categories_content">
        <div id="nsfw_categories">
          <% @nsfw_subreddits.each do |subreddit| %>
              <input type="checkbox" class="category nsfw_category" id="<%= subreddit %>"/><label for="<%= subreddit %>"><%= subreddit %></label>
          <% end %>
        </div>

        <div id="sfw_categories">
          <% @sfw_subreddits.each do |subreddit| %>
              <input type="checkbox" class="category sfw_category" id="<%= subreddit %>"/><label for="<%= subreddit %>"><%= subreddit %></label>
          <% end %>
        </div>
      </div>
    </div>


    <div id="start">
      <input type="submit" id="start_button" value="Go!"/>
    </div>
  </div>
</div>


<div id="viewer"></div>


<script>
    var images = [];
    var isMobile = jQuery.browser.mobile;
    var view = $('#viewer');
    var displayer = new ImageDisplayer(view, isMobile, recycleImg);
    var settings = new SettingsManager();
    var loader;


    $(function () {
        // style check boxes
        $(':checkbox, #start_button').button();

        // setup time slider for slideshow option
//        $('#slideshow_check').change(function () {
//            $('#time_slider').toggle('blind');
//        });
//
//        $(function () {
//            $("#slider-range-min").slider({
//                range: "min",
//                value: 4,
//                min: 1,
//                max: 10,
//                slide: function (event, ui) {
//                    $("#time").val(ui.value + " seconds");
//                }
//            });
//            $("#time").val($("#slider-range-min").slider("value") + " seconds");
//        });
//
//        // start slider hid with option unchecked
        $('#time_slider').hide();

        // add callback to toggle nsfw categories
        $('#nsfw_check').change(function () {
            // if the nsfw is checked show them and hide sfw
            if ($(this).is(':checked')) {
                $('#sfw_categories').hide("blind", {"complete": function () {
                    $('#nsfw_categories').show("blind");
                }});


            }

            else {
                $('#nsfw_categories').hide("blind", {"complete": function () {
                    $('#sfw_categories').show("blind");
                }});
            }
        });

        $('#start_button').click(start);

        // load settings from cookies
        settings.load();

        // set settings to save on unload
        $(window).unload(function () {
            settings.save();
        });
    });


    function start() {
        // save settings to cookies
        settings.save();

        var subreddits = [];
        if ($('#nsfw_check').is(':checked')) {
            $('.nsfw_category').each(function () {
                subreddits.push($(this).attr('id'));
            });
        } else {
            $('.sfw_category').each(function () {
                subreddits.push($(this).attr('id'));
            });
        }

        $.ajax({
            url: "http://localhost:3000/images/subreddits",
            data: {"subs": subreddits, gifs: $('#gif_check').is(':checked')}
        })
                .done(function (data) {

                    for (var index in data) {
                        images.push(data[index]);
                    }

                    loader = new ImageLoader(images);


                    $(document).bind('keydown touchend', keyPressed);

                    $(window).bind('orientationchange resize', function () {
                        displayer.redraw();
                    });

                    // Hide controls
                    $('#home').hide();
                    $('body').css('background-color', 'black');
                    $('html').css({cursor: 'none'});

                    // setup cursor hiding
                    var j, justHidden;
                    $(document).bind('mousemove', function () {
                        if (!justHidden) {
                            justHidden = false;
                            clearTimeout(j);
                            $('html').css({cursor: 'default'});
                            j = setTimeout(hide, 1000);
                        }
                    });
                    function hide() {
                        $('html').css({cursor: 'none'});
                        justHidden = true;
                        setTimeout(function () {
                            justHidden = false;
                        }, 500);
                    }

                    // start automatically changing
                    setInterval(function () {
                        changePicture();
                    }, 3000);

                    // Start showing pictures
                    changePicture();
                });
    }

    function finish() {
        $('#home').show();
        $('#viewer').hide();
        $('body').css('background-color', 'white');

        loader = null;
    }


    function keyPressed(e) {
        switch (e.keyCode) {
            // 'f'
            case 70:
                view.fullScreen();
                break;
            // 'esc'
            case 27:
                finish();
                break;
            default:
                changePicture();
                break;
        }
    }

    function recycleImg(image) {
        loader.useImage(image);
    }


    function changePicture() {
        displayer.setImage(loader.nextImage());
    }
</script>

