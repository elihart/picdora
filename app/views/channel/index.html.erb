<div id="intro">
  <h1>Welcome to Picdora <%= @user.name %>!</h1>

  <p>Like an image to see more like it! Dislike stuff you don't wanna see again.</p>

  <div id="controls">
    <h2>Controls:</h2>

    <ul>
      <li>Next Image - Right Arrow</li>
      <li>Previous Image - Left Arrow</li>
      <li>Like - Up Arrow</li>
      <li>Dislike - Down Arrow</li>
      <li>Fullscreen - f</li>
    </ul>
  </div>


    <input type="submit" id="start_button" value="Ok!"/>

</div>

<!-- Work around styling to center loading div -->
<div id="loading_container">
  <div style="display: table-cell; vertical-align: middle;">
    <div id="loading"></div>
  </div>
</div>

<div id="viewer"></div>

<div id="error_div"></div>

<script>
    var isMobile = jQuery.browser.mobile;
    var $view = $('#viewer');
    var channelId = <%=@channel.id%>;


    var displayer = new ImageDisplayer($view, isMobile);
    var settings = new SettingsManager();
    var loader = new ImageLoader(channelId);
    var loadingWidget = new LoadingWidget($('#loading'));

    PICDORA = {
        BASE_URL: "<%=request.base_url%>"
    };

    var j, justHidden;
    function checkCursor() {
        if (!justHidden) {
            justHidden = false;
            clearTimeout(j);
            $('html').css({cursor: 'default'});
            j = setTimeout(hide, 1000);
        }
    }
    function hide() {
        $('html').css({cursor: 'none'});
        justHidden = true;
        setTimeout(function () {
            justHidden = false;
        }, 500);
    }

    // runs after document loads
    $(function () {
        // style buttons
        $('input').button();

        $view.hide();
        $('#intro').hide();

        // show intro on login
        if (<%= !!flash[:login] %>) {
            $('#intro').show();
            $('#start_button').click(function () {
                start();
            });

        } else {
            start();
        }

        function start() {


            // Hide controls
            $('body').css('background-color', 'black');
            $('html').css({overflow: 'hidden'});
            loadingWidget.start();


            loader.loadQueue(function () {
                $(document).bind('keydown touchend', keyPressed);

                $(window).bind('orientationchange resize', function () {
                    displayer.redraw();
                });


                // setup cursor hiding
                $(document).bind('mousemove', checkCursor);
                $('html').css({cursor: 'none'});

                // Start showing pictures
                loadingWidget.stop();
                $view.show();
                changePicture();
            });
        }
    });

    function keyPressed(e) {
        switch (e.keyCode) {
            // 'f'
            case 70:
                $view.fullScreen();
                break;
            // 'esc'
            case 27:

                break;
            // 'i'
            case 73:
                imageLookup();
                break;
            // 's'
            case 83:
                saveImage(channelId, displayer.getCurrentImageId(), true, function () {
                    log("saved")
                });
                break;
            // 'r'
            case 82:
                reportImage(displayer.getCurrentImageId(),
                        function () {
                            log("reported")
                        });
                break;
            // left arrow
            case 37:
                previousPicture();
                break;
            // up arrow
            case 38:
                recordLike(channelId, displayer.getCurrentImageId(), true);
                changePicture();
                break;
            // right arrow
            case 39:
                changePicture();
                break;
            // down arrow
            case 40:
                recordLike(channelId, displayer.getCurrentImageId(), false);
                changePicture();
                break;
            default:

                changePicture();
                break;
        }
    }

    // shows the next picture in the queue
    function changePicture() {
        displayer.setImage(loader.nextImage());
    }

    // shows the previous picture if possible
    function previousPicture() {
        var img = loader.prevImage();
        if (img) {
            displayer.setImage(img);
        }
    }

</script>